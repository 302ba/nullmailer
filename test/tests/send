. functions

cat <<EOF >$tmpdir/libexec/nullmailer/dummy
#!/bin/sh
set -e
read host
read code
echo "\$host" | grep -q '^host='
exit \$code
EOF
chmod +x $tmpdir/libexec/nullmailer/dummy

echo 127.0.0.1 smtp >$SYSCONFDIR/remotes

# Start up the servers
start send $PWD/../src/nullmailer-send
start server tcpserver 0 24680 date

make_message() {
  msgid=$(date +%s).$$.me
  cat <<EOF >$tmpdir/var/nullmailer/tmp/$msgid
me@nowhere
me@nowhere

Subject: test
Message-Id: <$msgid>
EOF
  mv -f $tmpdir/var/nullmailer/tmp/$msgid $tmpdir/var/nullmailer/queue/$msgid
}

send_message() {
  echo 127.0.0.1 dummy $@ >$SYSCONFDIR/remotes
  make_message
  svc -a $tmpdir/service/send
  sleep 2
  not test -e $tmpdir/var/nullmailer/queue/$msgid
}

echo 'Testing sending with a succeeding protocol'
send_message 0 2.0.0
echo 'Testing sending with a failing protocol'
not send_message 1 5.2.2

echo 'Checking log outputs'
grep -q '^Starting delivery: host: 127.0.0.1 protocol: dummy file:' log
grep -qx 'From: <me@nowhere> to: <me@nowhere>' log
grep -qx 'Sending failed: Unspecified temporary error' log
grep -qx "Message-Id: <$msgid>" log
