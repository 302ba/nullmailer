tmpdir=/tmp/nm
rm -rf $tmpdir
mkdir -p $tmpdir/var/nullmailer/{queue,tmp}
mkdir -p $tmpdir/sbin
mkdir -p $tmpdir/etc/nullmailer
mknod $tmpdir/var/nullmailer/trigger p

#not() { if "$@"; then return 1; else return 0; fi }
not() { ! safe "$@"; }
safe() { set +e; "$@"; result=$?; set -e; return $result; }
error() {
  local code=$1
  shift
  if "$@"; then
    echo "Result was 0, should be $code."
    return 1
  else
    result=$?
    if test $result -eq $code; then
      return 0
    else
      echo "Result was $result, should be $code."
      return 1
    fi
  fi
}

inject() { ../src/nullmailer-inject "$@"; }
injectlines() {
  for line in "$@"; do
    echo "$line"
  done | inject -n
  return $?
}
injectfield() {
  local field=$1
  shift
  injectlines "$@" | grep -i "^$field:" | cut -d: -f2-
}
protocol() { local p=$1; shift; ../protocols/$p "$@" >/dev/null 2>&1; }

startsend() {
  ../src/nullmailer-send >$tmpdir/sendlog 2>&1 &
  sendpid=$!
  sleep 1
}
killsend() {
  kill $sendpid
  sleep 1
}

export PATH=/bin:/usr/bin:/usr/local/bin
export NULLMAILER_QUEUE=$PWD/../src/nullmailer-queue
rm -f $SYSCONFDIR/*
echo f.q.d.n >$SYSCONFDIR/me
echo q.d.n >$SYSCONFDIR/defaultdomain
echo smtp 127.0.0.1 >$SYSCONFDIR/remotes
set -e
